## 概要

Raspberry Pi PicoからSCD41センサーでCO2(二酸化炭素)濃度を測定、およびセンサーの設定変更やキャリブレーション(校正)をするサンプルプログラムです。

目的別にいくつかプログラムを用意しています。各プログラムの使い方は、後述の「使い方」を参照してください。

| ファイル名 | 機能 |
| ---- | ---- |
| [measure.c](measure.c) | CO2濃度測定 |
| [autocal.c](autocal.c) | 自動キャリブレーションの有効/無効化 |


## 対応製品

- [RPZ-CO2-Sensor](https://www.indoorcorgielec.com/products/rpz-co2-sensor/)


## 使い方

プロジェクトの開き方やボードの切り替えなど、各サンプルプログラム共通の使い方は[こちら](../)を参照してください。


### シリアルモニター

USBとUART0/GP0の両方へ動作ログを出力します。
シリアルモニターでいずれかをモニターすることで、動作ログを確認することができます。
シリアルモニターの使い方については[こちらの記事](https://www.indoorcorgielec.com/resources/pico/serial-monitor/)を参照してください。


### 測定値のモニター

[CMakeLists.txt](CMakeLists.txt)39行目のファイル名を「measure.c」でCMake、コンパイルすると、
CO2濃度測定プログラムとなります。
CO2を測定して結果をシリアルモニターに出力します。
プログラム開始後、5秒おきに10回シリアルモニターに以下のような測定値が表示されれば成功です！
~~~
CO2: 1692[ppm]
~~~


### 自動キャリブレーションの有効/無効化

初期状態でセンサーの自動キャリブレーションは有効になっています。
これにより、自動的に測定結果を補正することができます。

自動キャリブレーションを使う場合、「常時測定を行い、2週間に1回以上CO2濃度が外気相当(400ppm)になる」必要があります。
一例としては以下のような状況です。
- 換気されているオフィスで常時測定していて、休日や夜間は無人になる

一方で以下のような場合は自動キャリブレーションを無効化する必要があります。
- 短時間しか測定しない
- 夜間や休日も人がいる自宅
- 外気相当(400ppm)より低いCO2濃度になる可能性がある環境

[CMakeLists.txt](CMakeLists.txt)39行目のファイル名を「autocal.c」でCMake、コンパイルすると、
自動キャリブレーションの有効/無効化プログラムとなります。

[autocal.c](autocal.c)13行目の「AUTO_CAL_SET」の値を1にすると有効化, 0にすると無効化します。

プログラムを開始すると、シリアルモニターに現在の設定値、更新後の設定値が表示されます。
センサーの電源を落とした後も設定変更を反映させるため、最後に scd41_persist_settings を呼び出しています。


### 手動キャリブレーション

自動キャリブレーションが使用できない場合は手動キャリブレーションで補正を行ってください。
手動キャリブレーションには、CO2濃度が分かっている環境にセンサーを配置する必要があります。
そういった環境が無い場合は、外気(400ppm)の下に配置するようにして下さい。

[CMakeLists.txt](CMakeLists.txt)39行目のファイル名を「frc.c」でCMake、コンパイルすると、
手動キャリブレーションプログラムとなります。

[frc.c](frc.c)13行目の「FRC_TARGET」にCO2濃度を設定します。
十分に換気されていれば400ppm程度になりますが、作業者などの影響を加味して450をデフォルトにしています。

プログラムを開始すると、キャリブレーション前の5分間の測定を開始し、RPZ-CO2-Sensor基板の緑色LEDが点滅を始めます。
基板を外気中などに配置してください。近くに人や排気口などのCO2排出源が無いようにして下さい。
また、直射日光がセンサーに当たらないようにすることが推奨されています。

6分経過すると測定を停止し、scd41__perform_forced_recalibration を呼び出してキャリブレーションを行います。
キャリブレーションが完了するとRPZ-CO2-Sensor基板の緑色LEDが点灯になります。
